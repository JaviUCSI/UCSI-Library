<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UCSI School Library Management System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- External libraries from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {margin:0;padding:0;box-sizing:border-box;}
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1); overflow: hidden;}
        .header { background: linear-gradient(135deg, #2c3e50, #3498db); color: white; padding: 30px; text-align: center;}
        .header h1 { font-size: 2.5em; margin-bottom: 10px;}
        .nav { display: flex; justify-content: center; background: #34495e; flex-wrap: wrap;}
        .nav-btn { background: none; border: none; color: white; padding: 15px 25px; cursor: pointer; transition: background 0.3s; font-size: 16px;}
        .nav-btn:hover, .nav-btn.active { background: #2c3e50;}
        .content { padding: 30px; min-height: 600px;}
        .section { display: none;}
        .section.active { display: block;}
        .form-group { margin-bottom: 20px;}
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50;}
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;}
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db;}
        .btn { background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px; transition: transform 0.2s;}
        .btn:hover { transform: translateY(-2px);}
        .btn-success { background: linear-gradient(135deg, #27ae60, #229954);}
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b);}
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22);}
        .search-box { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 18px; margin-bottom: 20px;}
        .card { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; margin: 10px 0; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); transition: transform 0.2s, box-shadow 0.2s;}
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);}
        .card h3 { color: #2c3e50; margin-bottom: 10px;}
        .tag { display: inline-block; background: #3498db; color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; margin: 2px;}
        .status-available { color: #27ae60; font-weight: bold;}
        .status-borrowed { color: #e74c3c; font-weight: bold;}
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;}
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;}
        .stat-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; border-radius: 12px; text-align: center;}
        .stat-number { font-size: 2.5em; font-weight: bold; margin-bottom: 5px;}
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000;}
        .modal-content { background: white; margin: 5% auto; padding: 30px; width: 90%; max-width: 500px; border-radius: 12px; max-height: 80vh; overflow-y: auto;}
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #999;}
        .close:hover { color: #333;}
        .loan-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;}
        @media (max-width: 768px) {
            .nav { flex-direction: column; }
            .header h1 { font-size: 2em; }
            .content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <div style="display: flex; align-items: end; gap: 2px;">
                    <div style="width: 30px; height: 70px; background: linear-gradient(to bottom,#a93226 0%,#a93226 75%,white 75%,white 78%,#a93226 78%,#a93226 85%,white 85%,white 88%,#a93226 88%,#a93226 100%); border-radius: 5px 5px 0 0; border: 2px solid white; box-shadow: inset -3px 0 rgba(255,255,255,0.3),inset 3px 0 rgba(0,0,0,0.2),0 2px 5px rgba(0,0,0,0.4); font-family: Georgia, serif; font-size: 24px; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; display: flex; justify-content: center; align-items: center;">U</div>
                    <div style="width:28px;height:70px;background:linear-gradient(to bottom,#3498db 0%,#3498db 90%,white 90%,white 94%,#3498db 94%,#3498db 100%);border-radius:5px 5px 0 0;border:2px solid white;box-shadow:inset -3px 0 rgba(255,255,255,0.3),inset 3px 0 rgba(0,0,0,0.2),0 2px 5px rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;font-family:'Georgia',serif;font-size:24px;font-weight:bold;color:white;text-shadow:1px 1px 2px black;transform:rotate(-10deg);">C</div>
                    <div style="width:30px;height:70px;background:linear-gradient(to bottom,transparent 22%,white 22%,white 28%,transparent 28%),linear-gradient(145deg,#b9770e,#f1c40f);border-radius:5px 5px 0 0;border:2px solid white;box-shadow:inset -3px 0 rgba(255,255,255,0.3),inset 3px 0 rgba(0,0,0,0.2),inset -5 3px white,0 2px 5px rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;font-family:'Georgia',serif;font-size:24px;font-weight:bold;color:white;text-shadow:1px 1px 2px black;">S</div>
                    <div style="width:25px;height:70px;background:linear-gradient(to bottom,transparent 10%, white 10%, white 14%, transparent 14%, transparent 86%, white 86%, white 90%, transparent 90%),linear-gradient(145deg,#145a32,#2ecc71);border-radius:5px 5px 0 0;border:2px solid white;box-shadow:inset -3px 0 rgba(255,255,255,0.3),inset 3px 0 rgba(0,0,0,0.2),0 2px 5px rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;font-family:'Georgia',serif;font-size:24px;font-weight:bold;color:white;text-shadow:1px 1px 2px black;">I</div>
                </div>
                <div>
                    <h1 style="margin: 0;">UCSI International School Library</h1>
                    <p style="margin: 5px 0 0 0; opacity: 0.9;">Subang Jaya Campus - Digital Collection Management</p>
                </div>
            </div>
        </div>
        <div class="nav">
            <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
            <button class="nav-btn" onclick="showSection('books')">Books</button>
            <button class="nav-btn" onclick="showSection('users')">Users</button>
            <button class="nav-btn" onclick="showSection('loans')">Loans</button>
            <button class="nav-btn" onclick="showSection('reports')">Reports</button>
        </div>
        <div class="content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <h2>Library Dashboard</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-books">0</div>
                        <div>Total Books</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-users">0</div>
                        <div>Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-loans">0</div>
                        <div>Active Loans</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="overdue-loans">0</div>
                        <div>Overdue Items</div>
                    </div>
                </div>
                <h3>Recent Activity</h3>
                <div id="recent-activity"><div class="card"><p>Welcome to your Library Management System! Start by adding some books and users.</p></div></div>
            </div>
            <!-- Books Section -->
            <div id="books" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>Book Management</h2>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <button class="btn btn-success" onclick="openBookModal()">+ Add New Book</button>
                        <input type="file" id="import-books" accept=".xlsx,.xls,.csv" style="display: none;" onchange="importBooks(event)">
                        <button class="btn" onclick="document.getElementById('import-books').click()">üìÅ Import Books</button>
                        <button class="btn btn-warning" onclick="exportBooks()">üì§ Export Books</button>
                    </div>
                </div>
                <input type="text" class="search-box" id="book-search" placeholder="Search books by title, author, ISBN..." onkeyup="searchBooks()">
                <div id="books-list" class="grid">
                    <div class="card">
                        <p>No books in the library yet. Click "Add New Book" to get started!</p>
                    </div>
                </div>
            </div>
            <!-- Users Section -->
            <div id="users" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>User Management</h2>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <button class="btn btn-success" onclick="openUserModal()">+ Add New User</button>
                        <input type="file" id="import-users" accept=".xlsx,.xls,.csv" style="display: none;" onchange="importUsers(event)">
                        <button class="btn" onclick="document.getElementById('import-users').click()">üìÅ Import Users</button>
                        <button class="btn btn-warning" onclick="exportUsers()">üì§ Export Users</button>
                    </div>
                </div>
                <input type="text" class="search-box" id="user-search" placeholder="Search users by name, email..." onkeyup="searchUsers()">
                <div id="users-list" class="grid">
                    <div class="card">
                        <p>No users registered yet. Click "Add New User" to get started!</p>
                    </div>
                </div>
            </div>
            <!-- Loans Section -->
            <div id="loans" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                    <h2>Loan Management</h2>
                    <button class="btn btn-success" onclick="openLoanModal()">+ New Loan</button>
                </div>
                <input type="text" class="search-box" id="loan-search" placeholder="Search loans..." onkeyup="searchLoans()">
                <div id="loans-list">
                    <div class="card">
                        <p>No loans recorded yet. Add some books and users first, then create loans!</p>
                    </div>
                </div>
            </div>
            <!-- Reports Section -->
            <div id="reports" class="section">
                <h2>Reports & Analytics</h2>
                <div class="grid">
                    <div class="card">
                        <h3>Popular Books</h3>
                        <div id="popular-books">
                            <p>No loan data available yet.</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Active Borrowers</h3>
                        <div id="active-borrowers">
                            <p>No active borrowers yet.</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Overdue Items</h3>
                        <div id="overdue-items">
                            <p>No overdue items.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Book Modal -->
    <div id="book-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('book-modal')">√ó</span>
            <h3 id="book-modal-title">Add New Book</h3>
            <form id="book-form" onsubmit="saveBook(event)">
                <div class="form-group">
                    <label>Title:</label>
                    <input type="text" id="book-title" required>
                </div>
                <div class="form-group">
                    <label>Author:</label>
                    <input type="text" id="book-author" required>
                </div>
                <div class="form-group">
                    <label>ISBN:</label>
                    <input type="text" id="book-isbn">
                </div>
                <div class="form-group">
                    <label>Publisher:</label>
                    <input type="text" id="book-publisher">
                </div>
                <div class="form-group">
                    <label>Publication Year:</label>
                    <input type="number" id="book-year">
                </div>
                <div class="form-group">
                    <label>Category:</label>
                    <input type="text" id="book-category">
                </div>
                <div class="form-group">
                    <label>Location:</label>
                    <input type="text" id="book-location" placeholder="Shelf A1, Section 2">
                </div>
                <button type="submit" class="btn btn-success">Save Book</button>
                <button type="button" class="btn" onclick="closeModal('book-modal')">Cancel</button>
            </form>
        </div>
    </div>
    <!-- User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('user-modal')">√ó</span>
            <h3 id="user-modal-title">Add New User</h3>
            <form id="user-form" onsubmit="saveUser(event)">
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="user-name" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="user-email" required>
                </div>
                <div class="form-group">
                    <label>User Type:</label>
                    <select id="user-type" required>
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                        <option value="staff">Staff</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="tel" id="user-phone">
                </div>
                <div class="form-group">
                    <label>Department/Class:</label>
                    <input type="text" id="user-department">
                </div>
                <button type="submit" class="btn btn-success">Save User</button>
                <button type="button" class="btn" onclick="closeModal('user-modal')">Cancel</button>
            </form>
        </div>
    </div>
    <!-- Loan Modal -->
    <div id="loan-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('loan-modal')">√ó</span>
            <h3>New Loan</h3>
            <form id="loan-form" onsubmit="saveLoan(event)">
                <div class="form-group">
                    <label>Select Book:</label>
                    <select id="loan-book" required>
                        <option value="">Select a book...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Select User:</label>
                    <select id="loan-user" required>
                        <option value="">Select a user...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Due Date:</label>
                    <input type="date" id="loan-due-date" required>
                </div>
                <button type="submit" class="btn btn-success">Create Loan</button>
                <button type="button" class="btn" onclick="closeModal('loan-modal')">Cancel</button>
            </form>
        </div>
    </div>
    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:3000/api';
        
        // Data storage for temporary operations
        let books = [];
        let users = [];
        let loans = [];
        let currentEditId = null;

        // API Helper Functions
        class LibraryAPI {
            static async request(url, options = {}) {
                try {
                    const response = await fetch(`${API_BASE_URL}${url}`, {
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        ...options
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || `HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API Error:', error);
                    alert(`Error: ${error.message}`);
                    throw error;
                }
            }

            // Books API
            static async getBooks() {
                return this.request('/books');
            }

            static async createBook(bookData) {
                return this.request('/books', {
                    method: 'POST',
                    body: JSON.stringify(bookData)
                });
            }

            static async updateBook(id, bookData) {
                return this.request(`/books/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(bookData)
                });
            }

            static async deleteBook(id) {
                return this.request(`/books/${id}`, {
                    method: 'DELETE'
                });
            }

            static async getPopularBooks() {
                return this.request('/books/popular');
            }

            // Users API
            static async getUsers() {
                return this.request('/users');
            }

            static async createUser(userData) {
                return this.request('/users', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });
            }

            static async updateUser(id, userData) {
                return this.request(`/users/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(userData)
                });
            }

            static async deleteUser(id) {
                return this.request(`/users/${id}`, {
                    method: 'DELETE'
                });
            }

            // Loans API
            static async getLoans() {
                return this.request('/loans');
            }

            static async createLoan(loanData) {
                return this.request('/loans', {
                    method: 'POST',
                    body: JSON.stringify(loanData)
                });
            }

            static async returnLoan(id) {
                return this.request(`/loans/${id}/return`, {
                    method: 'PUT'
                });
            }

            static async getOverdueLoans() {
                return this.request('/loans/overdue');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            setDefaultDueDate();
        });

        // Load all data from API
        async function loadAllData() {
            try {
                await Promise.all([
                    loadBooks(),
                    loadUsers(),
                    loadLoans()
                ]);
                updateDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadBooks() {
            try {
                books = await LibraryAPI.getBooks();
                renderBooks();
            } catch (error) {
                books = [];
                renderBooks();
            }
        }

        async function loadUsers() {
            try {
                users = await LibraryAPI.getUsers();
                renderUsers();
                updateLoanDropdowns();
            } catch (error) {
                users = [];
                renderUsers();
            }
        }

        async function loadLoans() {
            try {
                loans = await LibraryAPI.getLoans();
                renderLoans();
            } catch (error) {
                loans = [];
                renderLoans();
            }
        }

        function importBooks(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    if (file.name.endsWith('.csv')) {
                        data = parseCSV(e.target.result);
                    } else {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        data = XLSX.utils.sheet_to_json(sheet);
                    }
                    const importedBooks = data.map(row => ({
                        id: nextBookId++,
                        title: row.title || row.Title || row.TITLE || '',
                        author: row.author || row.Author || row.AUTHOR || '',
                        isbn: row.isbn || row.ISBN || row.Isbn || '',
                        publisher: row.publisher || row.Publisher || row.PUBLISHER || '',
                        year: row.year || row.Year || row.YEAR || '',
                        category: row.category || row.Category || row.CATEGORY || '',
                        location: row.location || row.Location || row.LOCATION || ''
                    })).filter(book => book.title && book.author);
                    books = books.concat(importedBooks);
                    renderBooks();
                    updateDashboard();
                    alert(`Successfully imported ${importedBooks.length} books!`);
                } catch (error) {
                    alert('Error importing file. Please check the format and try again.');
                }
            };
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function importUsers(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    if (file.name.endsWith('.csv')) {
                        data = parseCSV(e.target.result);
                    } else {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        data = XLSX.utils.sheet_to_json(sheet);
                    }
                    const importedUsers = data.map(row => ({
                        id: nextUserId++,
                        name: row.name || row.Name || row.NAME || '',
                        email: row.email || row.Email || row.EMAIL || '',
                        type: (row.type || row.Type || row.TYPE || 'student').toLowerCase(),
                        phone: row.phone || row.Phone || row.PHONE || '',
                        department: row.department || row.Department || row.DEPARTMENT || row.class || row.Class || row.CLASS || ''
                    })).filter(user => user.name && user.email);
                    users = users.concat(importedUsers);
                    renderUsers();
                    updateLoanDropdowns();
                    updateDashboard();
                    alert(`Successfully imported ${importedUsers.length} users!`);
                } catch (error) {
                    alert('Error importing file. Please check the format and try again.');
                }
            };
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            return data;
        }

        function exportBooks() {
            if (books.length === 0) {
                alert('No books to export!');
                return;
            }
            const exportData = books.map(book => ({
                Title: book.title,
                Author: book.author,
                Identifier: book.identifier || '',
                Publisher: book.publisher || '',
                Year: book.publicationYear || '',
                Category: book.category || '',
                Location: book.location || '',
                Status: loans.some(loan => loan.book._id === book._id && !loan.returned) ? 'On Loan' : 'Available'
            }));
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Books');
            const fileName = `UCSI_Library_Books_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        }

        function exportUsers() {
            if (users.length === 0) {
                alert('No users to export!');
                return;
            }
            const exportData = users.map(user => {
                const activeLoans = loans.filter(loan => loan.user._id === user._id && !loan.returned).length;
                return {
                    Name: user.name,
                    Email: user.email,
                    Type: user.type,
                    Phone: user.phone || '',
                    Department: user.department || user.class || '',
                    'Active Loans': activeLoans
                };
            });
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Users');
            const fileName = `UCSI_Library_Users_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        }

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');
            if (sectionName === 'dashboard') updateDashboard();
            else if (sectionName === 'reports') generateReports();
        }

        function updateDashboard() {
            document.getElementById('total-books').textContent = books.length;
            document.getElementById('total-users').textContent = users.length;
            document.getElementById('active-loans').textContent = loans.filter(loan => !loan.returned).length;
            document.getElementById('overdue-loans').textContent = loans.filter(loan => !loan.returned && new Date(loan.dueDate) < new Date()).length;
            const recentActivity = document.getElementById('recent-activity');
            const recentLoans = loans.slice(-5).reverse();
            if (recentLoans.length === 0) {
                recentActivity.innerHTML = '<div class="card"><p>Welcome to your Library Management System! Start by adding some books and users.</p></div>';
            } else {
                recentActivity.innerHTML = recentLoans.map(loan => {
                    const status = loan.returned ? 'Returned' : 'Borrowed';
                    return `<div class="card"><strong>${loan.book?.title || 'Unknown Book'}</strong> ${status.toLowerCase()} by <strong>${loan.user?.name || 'Unknown User'}</strong> on ${new Date(loan.loanDate).toLocaleDateString()}</div>`;
                }).join('');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            currentEditId = null;
        }

        function setDefaultDueDate() {
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 14);
            document.getElementById('loan-due-date').value = dueDate.toISOString().split('T')[0];
        }

        function openBookModal(book = null) {
            document.getElementById('book-modal').style.display = 'block';
            document.getElementById('book-modal-title').textContent = book ? 'Edit Book' : 'Add New Book';
            if (book) {
                currentEditId = book._id;
                document.getElementById('book-title').value = book.title || '';
                document.getElementById('book-author').value = book.author || '';
                document.getElementById('book-isbn').value = book.identifier || '';
                document.getElementById('book-publisher').value = book.publisher || '';
                document.getElementById('book-year').value = book.publicationYear || '';
                document.getElementById('book-category').value = book.category || '';
                document.getElementById('book-location').value = book.location || '';
            } else {
                currentEditId = null;
                document.getElementById('book-form').reset();
            }
        }

        async function saveBook(event) {
            event.preventDefault();
            const bookData = {
                title: document.getElementById('book-title').value,
                author: document.getElementById('book-author').value,
                identifier: document.getElementById('book-isbn').value, // Map ISBN to identifier
                publisher: document.getElementById('book-publisher').value,
                publicationYear: parseInt(document.getElementById('book-year').value) || undefined,
                category: document.getElementById('book-category').value,
                location: document.getElementById('book-location').value
            };
            
            try {
                if (currentEditId) {
                    await LibraryAPI.updateBook(currentEditId, bookData);
                } else {
                    await LibraryAPI.createBook(bookData);
                }
                closeModal('book-modal');
                await loadBooks();
                updateDashboard();
            } catch (error) {
                // Error already handled in API class
            }
        }

        function renderBooks() {
            const booksList = document.getElementById('books-list');
            if (books.length === 0) {
                booksList.innerHTML = '<div class="card"><p>No books in the library yet. Click "Add New Book" to get started!</p></div>';
                return;
            }
            booksList.innerHTML = books.map(book => {
                const isAvailable = !loans.some(loan => loan.book._id === book._id && !loan.returned);
                return `<div class="card">
                        <h3>${book.title}</h3>
                        <p><strong>Author:</strong> ${book.author}</p>
                        <p><strong>Identifier:</strong> ${book.identifier || 'N/A'}</p>
                        <p><strong>Publisher:</strong> ${book.publisher || 'N/A'}</p>
                        <p><strong>Year:</strong> ${book.publicationYear || 'N/A'}</p>
                        <p><strong>Category:</strong> ${book.category || 'N/A'}</p>
                        <p><strong>Location:</strong> ${book.location || 'N/A'}</p>
                        <p class="${isAvailable ? 'status-available' : 'status-borrowed'}">${isAvailable ? '‚úÖ Available' : '‚ùå On Loan'}</p>
                        <div style="margin-top: 15px;">
                            <button class="btn" onclick="editBook('${book._id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteBook('${book._id}')">Delete</button>
                        </div>
                    </div>`;
            }).join('');
        }

        function editBook(id) {
            const book = books.find(b => b._id === id);
            if (book) {
                currentEditId = id;
                openBookModal(book);
            }
        }

        async function deleteBook(id) {
            if (confirm('Are you sure you want to delete this book?')) {
                try {
                    await LibraryAPI.deleteBook(id);
                    await loadBooks();
                    updateDashboard();
                } catch (error) {
                    // Error already handled in API class
                }
            }
        }

        function searchBooks() {
            const searchTerm = document.getElementById('book-search').value.toLowerCase();
            const filteredBooks = books.filter(book =>
                book.title.toLowerCase().includes(searchTerm) ||
                book.author.toLowerCase().includes(searchTerm) ||
                (book.identifier && book.identifier.toLowerCase().includes(searchTerm)) ||
                (book.category && book.category.toLowerCase().includes(searchTerm))
            );
            const booksList = document.getElementById('books-list');
            if (filteredBooks.length === 0 && books.length > 0) {
                booksList.innerHTML = '<div class="card"><p>No books found matching your search.</p></div>';
                return;
            }
            const originalBooks = [...books];
            books = filteredBooks;
            renderBooks();
            books = originalBooks;
        }

        function openUserModal(user = null) {
            document.getElementById('user-modal').style.display = 'block';
            document.getElementById('user-modal-title').textContent = user ? 'Edit User' : 'Add New User';
            if (user) {
                currentEditId = user._id;
                document.getElementById('user-name').value = user.name || '';
                document.getElementById('user-email').value = user.email || '';
                document.getElementById('user-type').value = user.type || 'Student';
                document.getElementById('user-phone').value = user.phone || '';
                document.getElementById('user-department').value = user.department || user.class || '';
            } else {
                currentEditId = null;
                document.getElementById('user-form').reset();
            }
        }

        async function saveUser(event) {
            event.preventDefault();
            const userData = {
                name: document.getElementById('user-name').value,
                email: document.getElementById('user-email').value,
                type: document.getElementById('user-type').value,
                phone: document.getElementById('user-phone').value,
                class: document.getElementById('user-department').value, // Map department to class
                department: document.getElementById('user-department').value
            };
            
            try {
                if (currentEditId) {
                    await LibraryAPI.updateUser(currentEditId, userData);
                } else {
                    await LibraryAPI.createUser(userData);
                }
                closeModal('user-modal');
                await loadUsers();
                updateDashboard();
            } catch (error) {
                // Error already handled in API class
            }
        }

        function renderUsers() {
            const usersList = document.getElementById('users-list');
            if (users.length === 0) {
                usersList.innerHTML = '<div class="card"><p>No users registered yet. Click "Add New User" to get started!</p></div>';
                return;
            }
            usersList.innerHTML = users.map(user => {
                const activeLoans = loans.filter(loan => loan.user._id === user._id && !loan.returned).length;
                return `<div class="card">
                        <h3>${user.name}</h3>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Type:</strong> ${user.type}</p>
                        <p><strong>Phone:</strong> ${user.phone || 'N/A'}</p>
                        <p><strong>Department/Class:</strong> ${user.department || user.class || 'N/A'}</p>
                        <p><strong>Active Loans:</strong> ${activeLoans}</p>
                        <div style="margin-top: 15px;">
                            <button class="btn" onclick="editUser('${user._id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteUser('${user._id}')">Delete</button>
                        </div>
                    </div>`;
            }).join('');
        }

        function editUser(id) {
            const user = users.find(u => u._id === id);
            if (user) {
                currentEditId = id;
                openUserModal(user);
            }
        }

        async function deleteUser(id) {
            const hasActiveLoans = loans.some(loan => loan.user._id === id && !loan.returned);
            if (hasActiveLoans) {
                alert('Cannot delete user with active loans. Please return all books first.');
                return;
            }
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    await LibraryAPI.deleteUser(id);
                    await loadUsers();
                    updateDashboard();
                } catch (error) {
                    // Error already handled in API class
                }
            }
        }

        function searchUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const filteredUsers = users.filter(user =>
                user.name.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm) ||
                user.type.toLowerCase().includes(searchTerm)
            );
            const usersList = document.getElementById('users-list');
            if (filteredUsers.length === 0 && users.length > 0) {
                usersList.innerHTML = '<div class="card"><p>No users found matching your search.</p></div>';
                return;
            }
            const originalUsers = [...users];
            users = filteredUsers;
            renderUsers();
            users = originalUsers;
        }

        function openLoanModal() {
            if (books.length === 0) {
                alert('Please add some books first before creating loans.');
                return;
            }
            if (users.length === 0) {
                alert('Please add some users first before creating loans.');
                return;
            }
            document.getElementById('loan-modal').style.display = 'block';
            updateLoanDropdowns();
            setDefaultDueDate();
        }

        function updateLoanDropdowns() {
            const bookSelect = document.getElementById('loan-book');
            const availableBooks = books.filter(book =>
                !loans.some(loan => loan.book._id === book._id && !loan.returned)
            );
            bookSelect.innerHTML = '<option value="">Select a book...</option>' +
                availableBooks.map(book =>
                    `<option value="${book._id}">${book.title} by ${book.author}</option>`
                ).join('');
            const userSelect = document.getElementById('loan-user');
            userSelect.innerHTML = '<option value="">Select a user...</option>' +
                users.map(user =>
                    `<option value="${user._id}">${user.name} (${user.type})</option>`
                ).join('');
        }

        async function saveLoan(event) {
            event.preventDefault();
            const loanData = {
                user: document.getElementById('loan-user').value,
                book: document.getElementById('loan-book').value,
                dueDate: document.getElementById('loan-due-date').value
            };
            
            try {
                await LibraryAPI.createLoan(loanData);
                closeModal('loan-modal');
                await loadLoans();
                await loadBooks();  // Refresh books to update availability status
                updateDashboard();
            } catch (error) {
                // Error already handled in API class
            }
        }

        function renderLoans() {
            const loansList = document.getElementById('loans-list');
            if (loans.length === 0) {
                loansList.innerHTML = '<div class="card"><p>No loans recorded yet. Add some books and users first, then create loans!</p></div>';
                return;
            }
            loansList.innerHTML = loans.map(loan => {
                const isOverdue = !loan.returned && new Date(loan.dueDate) < new Date();
                return `<div class="card">
                        <h3>${loan.book?.title || 'Unknown Book'}</h3>
                        <div class="loan-info">
                            <p><strong>Borrower:</strong> ${loan.user?.name || 'Unknown User'}</p>
                            <p><strong>Loan Date:</strong> ${new Date(loan.loanDate).toLocaleDateString()}</p>
                            <p><strong>Due Date:</strong> ${new Date(loan.dueDate).toLocaleDateString()}</p>
                            ${loan.returned ?
                                `<p><strong>Return Date:</strong> ${new Date(loan.returnDate).toLocaleDateString()}</p>` :
                                `<p class="${isOverdue ? 'status-borrowed' : 'status-available'}">
                                    ${isOverdue ? '‚ö†Ô∏è OVERDUE' : 'üìÖ Active Loan'}
                                </p>`
                            }
                        </div>
                        ${!loan.returned ?
                            `<button class="btn btn-success" onclick="returnBook('${loan._id}')">Mark as Returned</button>` :
                            '<p class="status-available">‚úÖ Returned</p>'
                        }
                    </div>`;
            }).join('');
        }

        async function returnBook(loanId) {
            try {
                await LibraryAPI.returnLoan(loanId);
                await loadLoans();
                await loadBooks();  // Refresh books to update availability status
                updateDashboard();
            } catch (error) {
                // Error already handled in API class
            }
        }

        function searchLoans() {
            const searchTerm = document.getElementById('loan-search').value.toLowerCase();
            const filteredLoans = loans.filter(loan => {
                return (loan.book?.title.toLowerCase().includes(searchTerm)) ||
                    (loan.user?.name.toLowerCase().includes(searchTerm));
            });
            const loansList = document.getElementById('loans-list');
            if (filteredLoans.length === 0 && loans.length > 0) {
                loansList.innerHTML = '<div class="card"><p>No loans found matching your search.</p></div>';
                return;
            }
            const originalLoans = [...loans];
            loans = filteredLoans;
            renderLoans();
            loans = originalLoans;
        }

        async function generateReports() {
            try {
                // Get popular books from API
                const popularBooksData = await LibraryAPI.getPopularBooks();
                document.getElementById('popular-books').innerHTML = popularBooksData.length > 0 ?
                    popularBooksData.slice(0, 5).map(item => `<p>${item.title} (${item.loanCount} loans)</p>`).join('') :
                    '<p>No loan data available yet.</p>';

                // Active borrowers
                const userLoans = {};
                loans.filter(loan => !loan.returned).forEach(loan => {
                    userLoans[loan.user._id] = (userLoans[loan.user._id] || 0) + 1;
                });
                const activeBorrowers = Object.entries(userLoans)
                    .map(([userId, count]) => {
                        const user = users.find(u => u._id === userId);
                        return { user, count };
                    })
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                document.getElementById('active-borrowers').innerHTML = activeBorrowers.length > 0 ?
                    activeBorrowers.map(item => `<p>${item.user?.name} (${item.count} active loans)</p>`).join('') :
                    '<p>No active borrowers yet.</p>';

                // Overdue items
                const overdueLoans = loans.filter(loan =>
                    !loan.returned && new Date(loan.dueDate) < new Date()
                );
                document.getElementById('overdue-items').innerHTML = overdueLoans.length > 0 ?
                    overdueLoans.slice(0, 5).map(loan => {
                        const daysOverdue = Math.floor((new Date() - new Date(loan.dueDate)) / (1000 * 60 * 60 * 24));
                        return `<p>${loan.book?.title} - ${loan.user?.name} (${daysOverdue} days overdue)</p>`;
                    }).join('') :
                    '<p>No overdue items.</p>';
            } catch (error) {
                console.error('Error generating reports:', error);
            }
        }
    </script>
</body>
</html>
